<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>字幕打印机</title>
    <style>
        #subtitle {
            font-size: 24px;
            color: #333;
        }
    </style>
</head>
<body>
    <input type="text" id="messageInput" placeholder="输入要显示的文本内容">
    <button onclick="sendMessage()">发送</button>
    <div id="subtitle"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <script>
        // 用于保存当前正在显示的动画的引用
        let currentAnimation;
        let isHiding = false;
        let hideSubtitle_Timeout;
        let hide_time = 1000;
        let auto_hide_time = 2000;

        const socket = io.connect('http://localhost:5500');

        socket.on('message', function(data) {
            showMessage(data.content);
        });

        // 显示文本内容的函数
        function showSubtitle(text, duration, auto_hide_time) {
            // 清空之前的文本内容
            clearSubtitle();

            // 停止当前的动画（如果有）
            if (currentAnimation) {
                cancelAnimationFrame(currentAnimation);
            }

            clearTimeout(hideSubtitle_Timeout);

            const subtitleDiv = document.getElementById("subtitle");
            subtitleDiv.innerText = "";
            subtitleDiv.style.opacity = 1;
            const textArray = text.split("");
            let currentIndex = 0;

            function showNextCharacter() {
                if (currentIndex < textArray.length) {
                    subtitleDiv.innerText += textArray[currentIndex];
                    currentIndex++;
                    currentAnimation = requestAnimationFrame(showNextCharacter);
                } else {
                    if (auto_hide_time) {
                        // 文本显示完成后的回调函数
                        hideSubtitle_Timeout = setTimeout(() => {
                            hideSubtitle(hide_time); // 渐变隐藏字幕
                        }, auto_hide_time); // 在显示 2 秒后开始隐藏
                    }
                    currentAnimation = undefined;
                }
            }

            showNextCharacter();
        }

        // 清空内容的函数
        function clearSubtitle() {
            const subtitleDiv = document.getElementById("subtitle");
            subtitleDiv.innerText = "";
        }

        // 渐变隐藏的函数
        function hideSubtitle(fadeOutDuration) {
            if (isHiding) {
                return; // 如果已经在隐藏过程中，不要再次触发
            }
            isHiding = true;

            const subtitleDiv = document.getElementById("subtitle");
            subtitleDiv.style.transition = `opacity ${fadeOutDuration}ms`;
            subtitleDiv.style.opacity = 0;

            setTimeout(() => {
                clearSubtitle();
                isHiding = false;
            }, fadeOutDuration);
        }

        function showMessage(message) {
            showSubtitle(message, 100, auto_hide_time);
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value;
            socket.emit('message', { content });
        }
    </script>
</body>
</html>

